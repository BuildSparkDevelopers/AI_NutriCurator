AI-NutriCurator/ # 📦 전체 프로젝트(“한 서비스”)
├─ README.md # 📄📢 사용법/실행법/팀 규칙 정리 (팀 모두)
├─ docker-compose.yml # 🐳🧩 DB/서버 한 번에 켜기 (백엔드)
├─ .env.example # 🔐🧾 환경변수 예시(키/DB주소) (백엔드)
├─ pyproject.toml # 📌📦 파이썬 패키지 목록/설정 (백엔드)
├─ alembic.ini # 🗃️⚙️ DB 테이블 변경 기록 관리 설정 (백엔드)
├─ alembic/ # 🗂️🗃️ DB 테이블 변경 기록(마이그레이션)
│ ├─ env.py # 🔌⚙️ DB 연결/실행 설정 (백엔드)
│ └─ versions/ # 🧱📚 테이블 변경 파일들이 쌓이는 곳 (백엔드)
├─ scripts/ # 🛠️⏯️ 한번만 돌리는 작업(데이터 넣기 등)
│ ├─ seed_demo_data.py # 🌱👤🛒 데모 유저/상품 데이터 넣기 (백엔드)
│ └─ build_vector_index.py # 🧠🔍 (선택) 검색용 인덱스 만들기 (RECO Agent 담당)
├─ tests/ # ✅🧪 자동 테스트
│ ├─ test_rules.py # ⚖️✅ 룰 코드 검사 (Rule 담당)
│ ├─ test_reco.py # 🔍✅ 후보 검색/정렬 검사 (RECO Agent 담당)
│ ├─ test_substitution.py # 🔁✅ 대체안 생성/필터/점수화 검사 (Substitution 담당)
│ ├─ test_cart.py # 🧺✅ (옵션/MVP X) 장바구니 합산/위반 검사 (CART 담당)
│ ├─ test_orchestrator.py # 🧭✅ “LLM 없이 분기 호출” 흐름 검사 (Orchestrator 담당)
│ ├─ test_api.py # 🌐✅ API 호출 테스트 (백엔드)
│ └─ test_tools.py # 🧰✅ “도구 함수들” 테스트 (USER/RECO/Sub/CART/Rule 공용)
└─ app/ # 🚀🏠 실제 서비스 코드(메인)
├─ main.py # ▶️🧭 서버 시작점(라우터 연결) (백엔드)
├─ settings.py # ⚙️🔐 환경변수 읽어서 설정 만들기 (백엔드)
├─ logging.py # 🧾🕵️ 기록 남기기(문제 추적용) (백엔드)
├─ errors.py # 🚨📨 에러를 똑같은 모양으로 보내기 (백엔드)
├─ security.py # 🔑🛡️ 로그인 토큰/비밀번호 처리 (백엔드)

├─ api/ # 🌐🚪 밖에서 들어오는 요청을 받는 곳
│ ├─ deps.py # 🧩🔌 공통 준비물(DB연결, 로그인 유저 꺼내기) (백엔드)
│ ├─ routes/ # 📮🗺️ URL별 기능(엔드포인트)
│ │ ├─ auth.py # 🔐👤 회원가입/로그인 (백엔드)
│ │ ├─ users.py # 👤🩺 유저/건강정보 저장/조회 (백엔드 + USER Agent 담당)
│ │ ├─ products.py # 🛒📋 상품 목록/상세 조회 (백엔드)
│ │ ├─ cart.py # 🧺📦 (옵션) 장바구니 저장/조회 (CART 입력용)
│ │ └─ ai.py # 🤖🚦 ⭐ 판정/추천 요청 → orchestrator 실행 (백엔드 + Orchestrator 담당)
│ └─ schemas/ # 📦📐 요청/응답 데이터 모양(프론트와 약속)
│ ├─ auth.py # 🔐🧾 로그인/회원가입 데이터 형식 (백엔드)
│ ├─ users.py # 👤🩺 유저/건강정보 데이터 형식 (백엔드 + USER Agent 담당)
│ ├─ products.py # 🛒📦 상품 데이터 형식 (백엔드)
│ ├─ cart.py # 🧺📦 (옵션) 장바구니 데이터 형식 (CART 담당)
│ └─ ai.py # 🤖📨 판정/추천 응답 형식 (Orchestrator + Composer 담당)

├─ domain/ # 🧠📏 서비스 ‘핵심 판단/정리’ 로직(LLM 말고 코드로 확정)
│ ├─ models/ # 🧱🗃️ DB에 저장할 데이터 설계도 SQLAlchemy
│ │ ├─ user.py # 👤🧱 유저 데이터 모양 (백엔드)
│ │ ├─ user_health_profile.py # 🩺🧱 건강정보 데이터 모양 (백엔드 + USER 담당)
│ │ ├─ guideline.py # 📏🧱 질환별 기준치/가이드 데이터 모양 (Rule 담당)
│ │ ├─ product.py # 🛒🧱 상품 데이터 모양 (백엔드)
│ │ ├─ product_nutrient.py # 🥗🧱 영양성분 데이터 모양 (백엔드)
│ │ └─ cart_item.py # 🧺🧱 (옵션) 장바구니 아이템 데이터 모양 (CART 담당)
│ ├─ services/ # 🧩🧠 “업무 로직” 함수 묶음(Agent가 호출)
│ │ ├─ user_service.py # 👤🧾 유저/건강정보를 판정용으로 정리 (USER 담당)
│ │ ├─ guideline_service.py # 📏🧾 기준치/금지 조건 정리 (Rule 담당)
│ │ ├─ product_service.py # 🛒🧾 상품 정보를 판정용으로 정리 (백엔드)
│ │ ├─ reco_service.py # 🔍🧾 “후보 상품” 넓게 모아오기 (RECO 담당)
│ │ ├─ substitution_service.py # 🔁🧾 “최종 대체안” 필터/점수/정렬/사유 (Sub 담당)
│ │ └─ cart_service.py # 🧺🧾 (옵션/MVP X) 장바구니 합산용 데이터 (CART 담당)
│ └─ rules/ # ⚖️🧷 OK/WARN/BLOCK 등 “판정 규칙”
│ ├─ rule_engine.py # 🧠⚖️ 규칙 결과 합쳐 최종 결론 (Rule 담당)
│ ├─ allergen_rules.py # 🚫🥜 알레르기/금지성분 규칙 (Rule 담당)
│ ├─ nutrient_rules.py # 🧂🍬 당/나트륨 등 수치 규칙 (Rule 담당)
│ ├─ substitution_rules.py # 🔁📊 대체안 점수/필터 규칙 (Sub+Rule 협업)
│ └─ cart_rules.py # 🧺📊 (옵션/MVP X) 장바구니 합산 규칙 (CART+Rule 협업)

├─ infra/ # 🔌🌍 “밖과 연결”(DB/Vector/Redis/LLM 등)
│ ├─ db/
│ │ ├─ session.py # 🗄️🔌 DB 연결 만들기 (백엔드) - DB url + create_engine()  
│ │ └─ repositories/ #CRUD
│ │ ├─ user_repo.py # 👤🗄️ 유저 DB 저장/조회 (백엔드)
│ │ ├─ health_repo.py # 🩺🗄️ 건강정보 DB 저장/조회 (백엔드)
│ │ ├─ guideline_repo.py # 📏🗄️ 기준치 DB 저장/조회 (Rule 담당)
│ │ ├─ product_repo.py # 🛒🗄️ 상품 DB 저장/조회 (백엔드)
│ │ └─ cart_repo.py # 🧺🗄️ 장바구니 DB 저장/조회 (CART 담당)
│ ├─ cache/ # ⚡🧠 잠깐 저장(선택)
│ │ ├─ redis_client.py # ⚡🔌 Redis 연결 (백엔드)
│ │ └─ state_store.py # 🧠🕒 최근 결과 저장(선택) (Orchestrator 담당)
│ ├─ vector/ # 🔍📚 비슷한 상품 찾기(검색 인프라)
│ │ ├─ client.py # 🔍🔌 검색 시스템 연결 (RECO 담당)
│ │ ├─ retriever.py # 🎯🔍 TopK 후보 검색 (RECO 담당)
│ │ └─ indexer.py # 🧱🧠 인덱스 만들기 (RECO 담당)
│ └─ llm/ # 🤖💬 “문장 생성/요약” 같은 LLM 기능 (Composer 담당 중심)
│ ├─ client.py # 🤖📡 LLM 요청 보내기 (Composer/LLM 담당)
│ └─ prompts/
│ ├─ composer.md # 📝🎨 팝업 문장 스타일/형식 (Composer 담당)
│ └─ system_rules.md # 📏🗣️ 공통 말하기 규칙(문장 톤/금지문구 등) (Composer+팀 합의)

└─ ai/ # 🧩🕸️ “에이전트 협업 순서/흐름”(LangGraph)
├─ state/
│ ├─ schema.py # 🧠📐 공용 메모장(칸 이름+모양) (Orchestrator 작성 + 모두 합의)
│ └─ builders.py # 🧱🛠️ state↔input/output 변환(형식 통일) (Orchestrator+백엔드 협업)
├─ contracts/
│ └─ agent_io.py # 🧾🔁 각 Agent가 읽고/쓰는 칸 목록(계약서) (Orchestrator 취합, 각 Agent 제출)
├─ tools/ # 🧰🧩 (공용) Agent들이 직접 import해서 실행하는 “도구 함수” 모음 ✅(이동)
│ ├─ init.py # 📦🧾 tool export 정리(한 곳에서 가져오기 쉽게 묶기) (공용/Orchestrator 협업)
│ ├─ user_tools.py # 👤🧰 USER Agent 도구(유저/프로필 로딩, 전처리) (USER 담당)
│ ├─ product_tools.py # 🛒🧰 상품 도구(상품/영양성분 조회, 정규화) (백엔드/RECO 협업)
│ ├─ reco_tools.py # 🔍🧰 후보 검색 도구(Vector 검색/카테고리 후보) (RECO 담당)
│ ├─ substitution_tools.py # 🔁🧰 대체안 생성 도구(필터/점수 계산/사유 생성) (Sub 담당)
│ ├─ cart_tools.py # 🧺🧰 (옵션/MVP X) 장바구니 합산/위반 도구 (CART 담당)
│ └─ rule_tools.py # ⚖️🧰 룰 엔진 실행 도구(OK/WARN/BLOCK 판정 호출) (Rule 담당)
├─ orchestrator/ # 🧭🕹️ “LLM 없이 분기 호출” 담당
│ ├─ runner.py # ▶️🧭 실행 시작/종료/에러 처리(진입점) (Orchestrator 담당)
│ ├─ policy.py # 🧠📌 결과값(state) 기반 분기 규칙(if/else) (Orchestrator 담당)
│ └─ graph.py # 🕸️🧭 LangGraph로 순서 정의(옵션) (Orchestrator 담당)
└─ agents/
├─ user_agent.py # 👤🧩 유저 정보를 state에 채움 (USER 담당)
├─ chat_core.py # 🧠🚦 판정/규칙 실행(“결론 값” 만들기) (CHAT Core 담당)
├─ reco_agent.py # 🔍🧩 후보 상품 넓게 찾기 (RECO 담당)
├─ substitution_agent.py # 🔁🧩 최종 대체안만 뽑기 (Substitution 담당)
├─ cart_scanner_agent.py # 🧺🧩 (옵션/MVP X) 장바구니 합산/위반 찾기 (CART 담당)
└─ composer_agent.py # 📝🧩 (LLM 사용) 최종 팝업 문장/카드 생성 (Composer 담당)

## ✅ 프로젝트 구조 규칙

### 1) 폴더 구조 규칙 (고정)

- `app`, `domain`, `infra`, `ai` ,`api`는 **항상 유지**
- 새 기능을 추가할 때도 이 5개 중 하나에 반드시 들어가야 함

### 2) 파일(.py) 규칙 (유연)

- `.py 파일명은 권장 템플릿일 뿐`
  → 기능이 커지면 **쪼개도 되고**, 작으면 **합쳐도 됨**
- → 혹은 다른 식으로 기능 분리 가능.
- 단, 아래 “필수 파일”은 고정

### ✅ 필수 파일 (절대 고정)

- `app/main.py` (서버 진입점)
- `app/settings.py` (환경변수/설정)
- `api/deps.py` (DB 세션, current_user 등)
- `infra/db/session.py` (DB 엔진/세션)
- `ai/state/schema.py` (state 계약)
- `ai/contracts/agent_io.py` (에이전트 IO 계약)
- `ai/orchestrator/graph.py` (그래프 구성)

### 3) 라우터/서비스/레포 역할 분리 규칙

- `routes/`는 **얇게** 유지
  - 입력 검증(Pydantic) + 서비스 호출 + 응답 반환만
- DB 쿼리는 **무조건 repositories로**
- 비즈니스 로직은 **services로**
- 외부 연결(DB/Redis/Vector/LLM)은 **infra로**

### 4) 에이전트 규칙 (가장 중요) - 02.03에 다시 정할 예정.

- 에이전트는 모두 다음 형태로 통일:

```python
def run(state: dict) -> dict:
    # read from state
    # call DB/vector/rules/llm
    # write back to state
    return state

```

- 에이전트는 “상대 영역 침범” 금지:
  - **DB 연결 코드는 infra**
  - **룰/판정은 domain/rules**
  - **오케스트레이션(순서/분기)은 ai/orchestrator**

### 5) 계약(Contract) 우선 규칙

- 개발 시작 전/변경 전 아래 두 파일을 먼저 합의:
  - `ai/state/schema.py` : state에 어떤 키들이 있고 타입이 뭔지
  - `ai/contracts/agent_io.py` : 각 agent가 state에서 **무엇을 읽고 무엇을 쓰는지**

### 6) Agent→Tool→Repo 호출

- ✅ Agent는 Tool을 import 한다
- ✅ Tool은 Service를 import 한다
- ✅ Service는 Repo를 import 한다

---

## ✅ 주의사항

> 폴더는 충돌 방지용으로 고정했고, 파일은 템플릿이라 합치거나 쪼개도 됩니다. 대신 state/agent 계약과 graph 실행 흐름만 꼭 지키기.

## rules/ 설계 시 참고하면 좋을 것.([이커머스용 상품 데이터 정의 ](https://www.notion.so/2fbe51228f4b8073a2e2dc0bbbe2acb1?pvs=21) )

- **Diabetes**
- **High-Blood-Pressure (HBP)**
- **Kidney**
- **Allergy**

WARN 근거는 크게 세 부류로 생각하면 설계가 쉬움:

- **태그 기반**: 알레르겐/회피 태그처럼 “있으면 바로 이유가 되는 것”
- **수치 기반**: 당/나트륨/칼륨/인 등 “숫자로 비교 가능한 것”
- **성분 텍스트 기반**(있으면): 성분표에서 특정 키워드가 잡히는 것

꼭 예시 폴더 구조처럼 .py를 나눌 필요 없음

# 프로젝트 구조 규칙 기반 PR 규칙

## 1) 어디에 코드 넣었는지 맞나?

- [ ] 요청/응답 처리면 `app/api`
- [ ] 판단/정리 로직이면 `domain`
- [ ] DB/LLM/Redis 연결이면 `infra`
- [ ] 단계 순서/흐름이면 `ai`

---

## 2) routes가 두꺼워지지 않았나?

- [ ] `api/routes`는 **입력 확인 → 호출 → 응답**만 함
- [ ] routes 안에 복잡한 로직/if/계산이 없다

---

## 3) DB를 repo에서만 만졌나?

- [ ] DB 조회/저장은 `infra/db/repositories`에서만 함
- [ ] routes/service/agent/tool에서 DB 직접 쿼리 안 함

---

## 4) 핵심 로직 위치 맞나?

- [ ] 계산/정리/추천 후보 만들기 = `domain/services`
- [ ] OK/WARN/BLOCK 판정 = `domain/rules`

---

## 5) tool은 “버튼답게” 얇나?

- [ ] tool은 `infra/llm/tools`에만 있음
- [ ] tool은 **한 번에 한 일만** 함 (서비스 호출 → 결과 반환)
- [ ] tool이 state를 직접 수정하지 않음
- [ ] tool 안에 “흐름(여러 단계)”이 들어있지 않음

---

## 6) 흐름(순서)은 ai가 담당했나?

- [ ] 실행 순서/분기는 `ai/orchestrator`에서만 함
- [ ] agent는 state 읽고/쓰고 tool 실행 결과만 담는다

---

## 7) 계약 파일 업데이트 했나? (변경 있었으면 필수)

- [ ] state 키/타입 바뀌면 `ai/state/schema.py`도 같이 수정
- [ ] agent가 읽고/쓰는 값 바뀌면 `ai/contracts/agent_io.py`도 같이 수정
