# 2월 24일 (월) 주요 변경사항 정리

## 📋 개요

- **변경 파일 수**: 34개
- **추가 파일**: 13개
- **수정 파일**: 16개
- **이름 변경**: 2개
- **삭제 파일**: 1개

---

## 🔥 주요 변경사항

### 1. 에이전트 파일 명명 규칙 정규화

#### 변경 사항

- `ai/agents/reco-agent.py` → `ai/agents/reco_agent.py`
- `ai/agents/sub-reco_agent.py` → `ai/agents/sub_reco_agent.py`

#### 이유

Python 파일명 규칙에 따라 하이픈(-) 대신 언더스코어(\_)를 사용하는 것이 표준

---

### 2. LangGraph 오케스트레이션 구조 추가

#### 신규 파일

- **`ai/orchestrator/graph.py`** (82줄)
  - LangGraph의 StateGraph를 기반으로 한 워크플로우 정의
  - 6개 에이전트 노드 연결:
    1. `orch_agent` (라우터 로직)
    2. `user_agent` (사용자 프로필 조회)
    3. `chat_agent` (영양가 기준값 평가)
    4. `reco_agent` (추천 생성)
    5. `sub_reco_agent` (대체 식재료 추천)
    6. `resp_agent` (응답 생성)
  - START → orch_agent 진입점 정의

#### 신규 파일

- **`ai/state/schema.py`** (71줄)
  - `overallState` TypedDict 정의 (전체 워크플로우 상태)
  - 상태 관리 필드:
    - 사용자 정보: `user_id`, `product_id`, `name`
    - 질환 정보: `diabetes_flag`, `hypertension_flag`, `kidneydisease_flag`, `allergy_flag`
    - 세부 질환 정보: `diabetes_detail`, `hypertension_detail`, `kidney_detail`, `allergy_list`
    - 분석 결과: `any_exceed`, `exceeded_nutrients`, `any_allergen`, `substitute`
    - 최종 결과: `allergy_safety_summary`, `final_answer`
  - `KFDAAllergen` Enum: 식약처 고시 22종 알레르기 유발 물질

---

### 3. 건강 관리 규칙 시스템 추가

#### 신규 파일

- **`domain/rules/allergen_rules.py`** (90줄)
  - 식약처 고시 22종 알레르기 유발 물질별 대체 식재료 추천
  - 각 알레르기 카테고리별 정보:
    ```
    - 난류 / 우유 / 메밀 / 땅콩 / 대두 / 밀 / 잣 / 호두 등
    - 각각에 대해 substitutes(대체식재료)와 usage_tip 제공
    ```

- **`domain/rules/nutrient_rules.py`** (88줄)
  - 식품 성분 매핑 테이블 (`FOOD_DB_MAPPER`)
    ```
    calories → 에너지(kcal)
    sodium → 나트륨(mg)
    carbohydrate → 탄수화물(g)
    sugar → 당류(g)
    fat → 지방(g)
    ... 등 12개 성분 매핑
    ```
  - `generate_final_profile()` 함수로 질환별 영양 임계값 정의:
    - **신부전(투석 전)**: 단백질(0.20 \* 체중kg), 나트륨, 인, 칼슘
    - **신부전(투석)**: 단백질(0.40 \* 체중kg), 나트륨, 칼륨, 인, 칼슘
    - **당뇨**: 당류 제한
    - **고혈압**: 나트륨, 칼륨, 지방 비율 제한

---

### 4. 챗 코어 에이전트 개선

#### 파일: `ai/agents/chat_core_agent.py`

- **변경 내용**:
  1. JSON 출력 형식 파싱 개선
  2. `any_*` 필드 디테일 보완
  3. `evaluate_threshold()` 메서드 개선
     - 프로필에서 분석 대상 영양소 동적 추출
     - `fat_ratio` 비율 계산 로직 개선
     - 기준값 초과 여부 체계적 분석
  4. `generate_allergy_prompt()` 추가로 알레르기 분석 로직 분리

- **주요 로직**:
  ```python
  # 영양성분 기준값 초과 분석
  - exclude_keys에서 user_id, restricted_ingredients 제외
  - 각 영양소별 limit 값과 actual 값 비교
  - fat_ratio는 (지방칼로리 / 총칼로리) 비율로 별도 계산
  ```

---

### 5. 서브 레코 에이전트 개선

#### 파일: `ai/agents/sub_reco_agent.py`

- **변경 내용**: 96줄 수정 (구체적 내용은 파일 검토 필요)
- 대체 식재료 추천 로직 강화

---

### 6. 사용자 에이전트 개선

#### 파일: `ai/agents/user_agent.py`

- **변경 내용**: 36줄 수정
- 사용자 프로필 조회 로직 개선

---

### 7. 데이터베이스 마이그레이션

#### 신규 마이그레이션

- **파일**: `alembic/versions/a1b2c3d4e5f6_alter_kidney_disease_enum.py` (59줄)
- **변경 사항**: 신부전 질환 enum 값 수정
  - 기존: 미정의 상태
  - 변경: `CKD_3_5` (투석 전), `HD` (혈액투석), `PD` (복막투석)
  - 기존 `kidneydisease_flag`를 더 세밀한 `kidney_detail` 필드로 분화

#### 관련 모델

- **파일**: `domain/models/user_health_profile.py`
  - 8줄 수정 (신부전 enum 업데이트)

---

### 8. API 엔드포인트 개선

#### 파일: `api/routes/ai.py`

- **변경 내용**: 56줄 수정
- AI 응답 라우팅 로직 개선
- 새로운 state schema 기반 요청 처리

---

### 9. 프론트엔드 업데이트

#### 파일 변경 목록:

1. **`frontend/next.config.ts`** - 10줄 수정
   - 빌드 최적화 설정 추가, 환경 설정 개선
2. **`frontend/package.json`** - 버전 업데이트
   - 의존성 버전 수정 (1줄)

3. **`frontend/src/app/globals.css`** - 스타일 추가 (8줄 수정)

4. **`frontend/src/app/layout.tsx`** - 15줄 수정
   - 메타데이터 관리 개선

5. **`frontend/src/components/AIMessagePanel.tsx`** - 77줄 수정
   - AI 응답 패널 UI 개선
   - 메시지 렌더링 로직 최적화

6. **`frontend/src/components/Banner.tsx`** - 2줄 수정
   - 배너 텍스트/스타일 조정

---

### 10. 설정 및 환경 파일 개선

#### 파일 변경 목록:

1. **`requirements.txt`** - 3줄 수정
   - 의존성 버전 업데이트

2. **`docker-compose.yml`** - 5줄 수정
   - 환경 설정 개선

3. **`infra/db/adapters.py`** - 8줄 수정
   - 데이터베이스 어댑터 로직 개선

---

### 11. 신규 관리 스크립트 추가

#### 신규 파일 (data/infrastructure 관리용):

- **`scripts/query_users_profiles.py`** - 사용자 프로필 조회
- **`scripts/run_add_master_user.py`** - 마스터 사용자 추가
- **`scripts/update_master_activity.py`** - 마스터 활동 업데이트
- **`scripts/update_test_profiles_11_14.py`** - 테스트 프로필 일괄 업데이트 (125줄)
- **`scripts/update_user_passwords.py`** - 사용자 비밀번호 업데이트 (42줄)

---

### 12. 오케스트레이션 계획 문서 추가

#### 신규 파일

- **`langgraph_refactoring_plan.md`** (86줄)
  - LangGraph 아키텍처 리팩토링 계획
  - 기존 `langgrapharchitecture.py` 대체
  - 모듈화된 그래프 구조 설계

---

### 13. 삭제 파일

- **`langgrapharchitecture.py`** (1280줄) 삭제
  - 이유: 새로운 모듈화 구조(`ai/orchestrator/graph.py`)로 대체
  - 레거시 코드 정리

---

### 14. 보안 파일 추가

- **`buildspark.pem`** - AWS/배포용 PEM 인증서 파일 추가

---

### 15. 작업 문서 추가

#### 신규 마크다운 문서:

- **`260224오전리포트.md`** - 아침 리포트
- **`작업내역260223.md`** - 2월 23일 작업 내역
- **`작업내역260224.md`** - 2월 24일 작업 내역
- **`발표대본.md`** - 발표 대본

---

## 🔗 아키텍처 흐름도

```
시작 (START)
    ↓
orch_agent (RouterLogic - 요청 라우팅)
    ↓
  ┌─────────────┬────────────────────┬──────────────┐
  ↓             ↓                    ↓              ↓
user_agent   chat_agent          reco_agent    (다른 로직)
(프로필조회) (영양성분 분석)      (추천 생성)
  ↓             ↓
  └──────→ evaluate_threshold()
          (기준값 초과 분석)
             ↓
          sub_reco_agent
          (대체식재료 추천)
             ↓
          resp_agent
          (응답 생성)
             ↓
           END
```

---

## 🎯 주요 개선 사항 요약

| 항목             | 개선 사항                           |
| ---------------- | ----------------------------------- |
| **코드 구조**    | 모놀리식 → 모듈화 (LangGraph 기반)  |
| **상태 관리**    | 중앙집중식 (overallState TypedDict) |
| **규칙 엔진**    | 알레르기 & 영양 규칙 체계화         |
| **데이터베이스** | 신부전 질환 분류 세분화             |
| **프론트엔드**   | UI/UX 개선 및 메시지 렌더링 최적화  |
| **배포**         | Docker 및 환경 설정 개선            |

---

## ✅ 체크리스트 (후속 작업)

- [ ] 새 마이그레이션 실행 (`alembic upgrade head`)
- [ ] `ai/agents/composer_agent.py` 구현 확인 (graph.py에서 import하고 있음)
- [ ] `graph.py`의 모델 초기화 패턴 검토 (현재 `model=None`으로 되어있음)
- [ ] 프론트엔드 빌드 테스트
- [ ] AI 라우팅 로직 통합 테스트
- [ ] 새 상태 스키마 기반 E2E 테스트

---

## 📝 작업자 노트

이번 업데이트는 프로젝트의 **골자 아키텍처 현대화**를 중심으로 진행됨:

1. **LangGraph 도입**: 복잡한 에이전트 간 상호작용을 명확한 그래프 구조로 시각화
2. **규칙 엔진 분리**: 비즈니스 로직을 별도 모듈로 분리하여 유지보수성 향상
3. **상태 중앙화**: TypedDict 기반 명확한 타입 정의로 안정성 증대
4. **질환 분류 개선**: 신부전을 세 가지 단계(`CKD_3_5`, `HD`, `PD`)로 세분화

---

**마지막 업데이트**: 2026-02-24 (GIT PULL)
