# 작업내역 260223 (2026-02-23)

git pull 이후 로컬에서 반영된 변경 사항을 파일별로 정리합니다.

## 변경 파일 목록
- [ai/agents/sub-reco_agent.py](ai/agents/sub-reco_agent.py)
- [SUB_RECO_GUIDE.md](SUB_RECO_GUIDE.md)
- [docker-compose.yml](docker-compose.yml)

---

## 상세 변경 내역

### 1) [ai/agents/sub-reco_agent.py](ai/agents/sub-reco_agent.py)
- 신규 추가
  - `SubstitutionReco.calculate_health_scores(product_id: str, state: Dict[str, Any]) -> Dict[str, float]`
    - overallState의 `user_profile` 플래그(diabetes_flag, hypertension_flag, kidneydisease_flag)가 1인 질병만 선별해 다중 점수를 일괄 계산.
    - 신장질환 옵션은 `user_profile`에서 읽어 사용: `kidney_detail`(→ kidney_stage), `is_processed_food`, `weight`.
- 로직 변경 (신장질환 집계부)
  - `DiseaseScoring.calculate_kidney_disease_score(...)` 최종 점수 집계 방식 조정:
    - 이전(문서 기준): Final = 0.7 × max(scores) + 0.3 × avg(scores)
    - 현재(코드): riskScores = [Na, K, P, Protein] → Final = 100 - (0.7 × max_risk + 0.3 × avg_risk)
    - 반환값은 0–100 범위로 클램프.
- 호환성
  - 기존 단일 API `calculate_health_score(...) -> float`는 유지.
  - `validate_swap`, `generate_recommendations`는 기존 단일 API를 계속 사용(호출부 변경 없음).

### 2) [SUB_RECO_GUIDE.md](SUB_RECO_GUIDE.md)
- 신장질환 점수 섹션 전면 보강
  - Na/K/P/단백질 점수 산식(Hill/Michaelis-Menten), 단계별(CKD_3_5/HD/PD) 수식, 파라미터(`kidney_stage`, `is_processed_food`, `weight`)와 단위 명시.
  - 예시 코드 추가(옵션 활용 사례 포함).
- 사용 섹션 보강
  - 5.1 개별 점수 계산: 신장질환 인자 사용 예시 추가.
  - 5.3 대체 상품 검증: 신장질환 인자 사용 예시 추가.
- 주의사항 보강
  - `weight` 미설정 시 단백질 점수 50 처리, 가공식품 인 흡수율 1.5배, 단계별 칼륨 수식 차이 명시.
- 참고(정합성)
  - 문서의 최종 점수 예시는 `Final = 0.7 × max + 0.3 × avg`로 기재되어 있어, 현재 코드의 "위험점수 역산(100 - …)" 방식과 차이가 있습니다. 추후 코드·문서 통일 필요.

### 3) [docker-compose.yml](docker-compose.yml)
- Postgres 포트 매핑 변경
  - `${POSTGRES_PORT:-5432}:5432` → `${POSTGRES_PORT:-5433}:5433`
  - 서비스 정의/볼륨/헬스체크 구조는 동일.

---

## 후속 제안
- 신장질환 최종 점수 집계 방식(문서 vs 코드) 통일.
- `generate_recommendations`가 멀티 점수 API(`calculate_health_scores`)를 활용하도록 점진 리팩터링.
- 환경 변수 `.env`의 `POSTGRES_PORT` 기본값(5433) 확인 및 README 반영.
