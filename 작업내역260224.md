# 작업내역 260224 (2026-02-24)

오늘 작업 내용을 총정리합니다.

---

## 1. AI 엔드포인트 확인

### API 개요
- **경로:** `POST /api/v1/ai/analyze`
- **요청:** `{ "product_id": number }`
- **인증:** JWT Bearer 토큰 필요

### 응답 스키마
| 필드 | 설명 |
|------|------|
| `status` | `"ok"` (성공 시) |
| `decision` | `"safe"` / `"warning"` / `"caution"` |
| `reason_summary` | 분석 요약 |
| `alternatives` | 대체 추천 상품 목록 |
| `product_name` | 분석한 상품명 |
| `next_step` | 그래프 다음 단계 |
| `full_state_debug` | LangGraph 최종 state (디버깅용) |

### Swagger Try it out
- `product_id: 0`은 Swagger 기본값 → 실제 존재하는 상품 ID로 변경 필요

---

## 2. 인증 및 토큰 이슈

### PowerShell에서 API 호출
- Windows PowerShell의 `curl`은 `Invoke-WebRequest` 별칭 → Unix curl 문법 미지원
- **해결:** `curl.exe` 사용 또는 `Invoke-RestMethod` 사용

### INVALID_TOKEN
- `<access_token>` 문자열 그대로 전송 시 발생 → 로그인 후 실제 JWT 토큰 사용 필요

### hash could not be identified
- DB `users` 테이블의 `password_hash`가 bcrypt 형식이 아님
- `app_dump.sql`의 `hash_value_xxx`는 더미 값 → bcrypt 해시(`$2b$12$...`)로 교체 필요

---

## 3. DB 계정 및 프로필 작업

### 3.1 master@naver.com 계정 추가
- **파일:** [scripts/add_master_user.sql](scripts/add_master_user.sql)
- **로그인:** `master@naver.com` / `thgudtjs1!!`
- **users:** bcrypt 해시, is_sensitive_agreed=true, is_tos_agreed, is_privacy_agreed
- **user_health_profile:** gender=F, birth_date=1993-02-25, height=160, weight=50, average_of_steps=10000, activity_level=5, diabetes/hypertension/kidneydisease/allergy=na, goal=normal
- `currval('users_user_id_seq')`로 user_id 자동 연결

### 3.2 user_id 1~20 비밀번호 업데이트
- 비밀번호를 이메일 `@` 앞 부분으로 설정 (예: user1@example.com → user1)
- bcrypt 해시 생성 후 DB 업데이트
- **스크립트:** [scripts/update_user_passwords.py](scripts/update_user_passwords.py)

### 3.3 user_id 11~14 단일 질병 테스트 계정
- **파일:** [scripts/update_test_profiles_11_14.py](scripts/update_test_profiles_11_14.py)
- user_id 11: 당뇨 type1
- user_id 12: 고혈압 stage1
- user_id 13: 신장질환 HD (혈액투석)
- user_id 14: 알러지 milk

---

## 4. kidney_disease_enum 변경

### 4.1 변경 내용
- **이전:** `chronic_kidney_disease`, `kidney_failure`, `kidney_stones`, `proteinuria`, `nephrotic_syndrome`, `na`
- **이후:** `CKD_3_5`, `HD`, `PD`, `na`

### 4.2 수정 파일
- [alembic/versions/a1b2c3d4e5f6_alter_kidney_disease_enum.py](alembic/versions/a1b2c3d4e5f6_alter_kidney_disease_enum.py)
  - 기존 데이터 매핑: kidney_failure→HD, na→na, 그 외→CKD_3_5
- [domain/models/user_health_profile.py](domain/models/user_health_profile.py)
  - `KidneyDisease` enum: `CKD_3_5`, `HD`, `PD`, `na`

### 4.3 user_id 13 프로필
- `kidneydisease`: `HD` (혈액투석)로 설정

---

## 5. Git 및 배포

### 5.1 develop 브랜치 push
- kidney_disease_enum 변경, Alembic 마이그레이션, 테스트 스크립트 추가

### 5.2 전체 push
- frontend (next.config.ts, package.json, globals.css, layout.tsx, AIMessagePanel, Banner)
- requirements.txt
- 기획서.md
- `frontend/tsconfig.tsbuildinfo`는 빌드 캐시로 제외

---

## 6. 추가/수정 스크립트 목록

| 스크립트 | 용도 |
|----------|------|
| add_master_user.sql | master@naver.com 계정 추가 |
| run_add_master_user.py | master 계정 생성 실행 |
| update_master_activity.py | master activity_level 수정 |
| update_user_passwords.py | user_id 1~20 비밀번호 bcrypt 업데이트 |
| update_test_profiles_11_14.py | user_id 11~14 단일 질병 테스트 프로필 |
| query_users_profiles.py | users/user_health_profile 조회 |

---

## 7. 참고

- **로그인 테스트:** user1@example.com / user1, user2@example.com / user2 등 (이메일 @ 앞 부분이 비밀번호)
- **AI 분석:** 건강 프로필이 설정된 사용자만 가능
